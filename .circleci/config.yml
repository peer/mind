version: 2
jobs:
  build:
    docker:
      - image: tozd/meteor-testing:ubuntu-xenial
    environment:
      - METEOR_ALLOW_SUPERUSER: true
    steps:
      - checkout
      - run: git submodule update --init --recursive
      - run: tests/authors/check-authors.sh
      - run:
          command: |
            # No merge marks in commits.
            ! git log --oneline "-G^(<<<<<<<|=======|>>>>>>>)" | grep '^'
      - run: meteor npm install --unsafe-perm -g cli-real-favicon
      - run: meteor npm install --unsafe-perm
      - run:
          command: Xvfb -screen 0 1280x1024x24
          background: true
          no_output_timeout: 24h
      - run: tests/test-runner/test-all.sh
      - run: real-favicon check-for-update --fail-on-update public/version.json
      - store_test_results:
          path: test-reports/
